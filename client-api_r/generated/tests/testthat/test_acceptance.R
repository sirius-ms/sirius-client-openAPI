# Automatically generated by openapi-generator (https://openapi-generator.tech)
# Please update as you see appropriate

context("Test Acceptance")
options(warn = -1)

sdk <- SiriusSDK$new()
api <- sdk$attach_to_sirius(sirius_port=8080)
api_instance <- api$jobs_api
features_api <- api$features_api
projects_api <- api$projects_api
path_to_demo_data <- paste(Sys.getenv("HOME"), "sirius-client-openAPI/.updater/clientTests/Data", sep = "/")
input_file <- paste(path_to_demo_data, "Kaempferol.ms", sep = "/")

test_that("Test Acceptance", {

  tryCatch({

    project_id <- "AcceptanceTest"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep = "/")
    projects_api$CreateProject(project_id, project_dir)
    import_job <- projects_api$ImportPreprocessedDataAsJob(project_id, input_files = input_file, ignore_formulas = TRUE)
    Sys.sleep(1)

    job_submission <- api_instance$GetDefaultJobConfig()
    job_submission$zodiacParams$enabled <- FALSE
    job_submission$
      fingerprintPredictionParams$
      enabled <- FALSE
    job_submission$canopusParams$enabled <- FALSE
    job_submission$structureDbSearchParams$enabled <- FALSE
    job_submission$msNovelistParams$enabled <- FALSE
    job_submission$alignedFeatureIds <- list(features_api$GetAlignedFeatures(project_id)[[1]]$alignedFeatureId)

    response <- api_instance$StartJob(project_id, job_submission)
    api$wait_for_job_completion(project_id, response$id, 60)

    formula_candidate <- features_api$GetAlignedFeature(project_id, job_submission$alignedFeatureIds[[1]], opt_fields = list("topAnnotations"))$
      topAnnotations$
      formulaAnnotation
    tree <- features_api$GetFragTree(project_id, job_submission$alignedFeatureIds[[1]], formula_candidate$formulaId)

    expect_true(inherits(formula_candidate, "FormulaCandidate"))
    expect_true(inherits(tree, "FragmentationTree"))
    expect_equal("C15H10O6", formula_candidate$molecularFormula)

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})
