# Automatically generated by openapi-generator (https://openapi-generator.tech)
# Please update as you see appropriate

context("Test JobsApi")
options(warn=-1)

sdk <- SiriusSDK$new()
api <- sdk$attach_to_sirius(sirius_port=8080)
api_instance <- api$jobs_api
features_api <- api$features_api
projects_api <- api$projects_api
path_to_demo_data <- paste(Sys.getenv("HOME"), "sirius-client-openAPI/.updater/clientTests/Data", sep="/")
input_file <- paste(path_to_demo_data, "Kaempferol.ms", sep="/")


test_that("DeleteJob", {
  # tests for DeleteJob
  # base path: http://localhost:8080
  # Delete job.
  # Delete job. Specify how to behave for running jobs.
  # @param project_id character project-space to delete job from
  # @param job_id character of the job to be deleted
  # @param cancel_if_running character If true job will be canceled if it is not finished. Otherwise,                         deletion will fail for running jobs or request will block until job has finished. (optional)
  # @param await_deletion character If true request will block until deletion succeeded or failed.                         If the job is still running the request will wait until the job has finished. (optional)
  # @return [Void]

  tryCatch({

    project_id <- "DeleteJob"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file)

    response_before <- api_instance$GetJobs(project_id)
    api_instance$DeleteJob(project_id, response_before[[1]]$id, await_deletion=TRUE)
    response_after <- api_instance$GetJobs(project_id)
    expect_equal(length(response_before), length(response_after)+1)

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("DeleteJobConfig", {
  # tests for DeleteJobConfig
  # base path: http://localhost:8080
  # Delete job configuration with given name.
  # Delete job configuration with given name.
  # @param name character name of the job-config to delete
  # @return [Void]

  tryCatch({

    project_id <- "DeleteJobConfig"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)

    job_submission <- api_instance$GetDefaultJobConfig(TRUE)
    api_instance$SaveJobConfig(project_id, job_submission, TRUE)

    response_before <- api_instance$GetJobConfigs()
    api_instance$DeleteJobConfig(project_id)
    response_after <- api_instance$GetJobConfigs()
    expect_equal(length(response_before), length(response_after)+1)

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("DeleteJobs", {
  # tests for DeleteJobs
  # base path: http://localhost:8080
  # * Delete ALL jobs.
  # * Delete ALL jobs. Specify how to behave for running jobs.
  # @param project_id character project-space to delete jobs from
  # @param cancel_if_running character If true job will be canceled if it is not finished. Otherwise,                         deletion will fail for running jobs or request will block until job has finished. (optional)
  # @param await_deletion character If true request will block until deletion succeeded or failed.                         If the job is still running the request will wait until the job has finished. (optional)
  # @return [Void]

  tryCatch({

    project_id <- "DeleteJob"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file)

    response_before <- api_instance$GetJobs(project_id)
    api_instance$DeleteJobs(project_id, await_deletion=TRUE)
    response_after <- api_instance$GetJobs(project_id)
    expect_equal(length(response_before), length(response_after)+1)

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("GetCommand", {
  # tests for GetCommand
  # base path: http://localhost:39109
  # Get a CLI command for the given job configuration.
  # Get a CLI command for the given job configuration.
  # @param job_submission JobSubmission
  # @return [array[character]]

  default_config <- api_instance$GetDefaultJobConfig(TRUE)
  response <- api_instance$GetCommand(default_config)

  expect_true(inherits(response, "list"))
  expect_true(inherits(response[[1]], "character"))
})

test_that("GetDefaultJobConfig", {
  # tests for GetDefaultJobConfig
  # base path: http://localhost:8080
  # Request default job configuration
  # Request default job configuration
  # @param include_config_map character if true, generic configmap with-defaults will be included (optional)
  # @return [JobSubmission]

  response <- api_instance$GetDefaultJobConfig(TRUE)
  expect_true(inherits(response, "JobSubmission"))
})

test_that("GetJob", {
  # tests for GetJob
  # base path: http://localhost:8080
  # Get job information and its current state and progress (if available).
  # Get job information and its current state and progress (if available).
  # @param project_id character project-space to run jobs on
  # @param job_id character of the job to be returned
  # @param opt_fields array[JobOptField] set of optional fields to be included. Use 'none' only to override defaults. (optional)
  # @return [Job]

  tryCatch({

    project_id <- "GetJob"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file)
    job_id <- api_instance$GetJobs(project_id)[[1]]$id

    response <- api_instance$GetJob(project_id, job_id)
    expect_true(inherits(response, "Job"))

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("GetJobConfig", {
  # tests for GetJobConfig
  # base path: http://localhost:8080
  # Request job configuration with given name.
  # Request job configuration with given name.
  # @param name character name of the job-config to return
  # @param include_config_map character if true the generic configmap will be part of the output (optional)
  # @return [JobSubmission]

  config_name <- "GetJobConfig"
  job_submission <- api_instance$GetDefaultJobConfig(TRUE)
  api_instance$SaveJobConfig(config_name, job_submission, TRUE)

  response <- api_instance$GetJobConfig(config_name)

  expect_true(inherits(response, "StoredJobSubmission"))
  expect_equal(response$name, config_name)
})

test_that("GetJobConfigs", {
  # tests for GetJobConfigs
  # base path: http://localhost:8080
  # Request all available job configurations
  # Request all available job configurations
  # @param include_config_map character if true the generic configmap will be part of the output (optional)
  # @return [array[JobSubmission]]

  config_name <- "GetJobConfigs"
  job_submission <- api_instance$GetDefaultJobConfig(TRUE)
  api_instance$SaveJobConfig(config_name, job_submission, TRUE)

  response <- api_instance$GetJobConfigs()

  expect_true(inherits(response, "list"))
  expect_true(inherits(response[[1]], "StoredJobSubmission"))
})

test_that("GetJobs", {
  # tests for GetJobs
  # base path: http://localhost:8080
  # Get List of all available jobs with information such as current state and progress (if available).
  # Get List of all available jobs with information such as current state and progress (if available).
  # @param project_id character project-space to run jobs on
  # @param opt_fields array[JobOptField] set of optional fields to be included. Use 'none' only to override defaults. (optional)
  # @return [array[Job]]

  tryCatch({

    project_id <- "GetJobs"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file)

    response <- api_instance$GetJobs(project_id)
    expect_true(inherits(response, "list"))
    expect_true(inherits(response[[1]], "Job"))

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("GetJobsPaged", {
  # tests for GetJobsPaged
  # base path: http://localhost:8080
  # Get Page of jobs with information such as current state and progress (if available).
  # Get Page of jobs with information such as current state and progress (if available).
  # @param project_id character project-space to run jobs on
  # @param page integer Zero-based page index (0..N) (optional)
  # @param size integer The size of the page to be returned (optional)
  # @param sort array[character] Sorting criteria in the format: property,(asc|desc). Default sort order is ascending. Multiple sort criteria are supported. (optional)
  # @param opt_fields array[JobOptField] set of optional fields to be included. Use 'none' only to override defaults. (optional)
  # @return [PageJob]

  tryCatch({

    project_id <- "GetJobsPaged"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file)

    response <- api_instance$GetJobsPaged(project_id)
    expect_true(inherits(response, "PagedModelJob"))

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("HasJobs", {
  # tests for HasJobs
  # base path: http://localhost:8080
  # @param project_id character
  # @param include_finished character  (optional)
  # @return [character]

  tryCatch({

    project_id <- "HasJobs"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file)

    response <- api_instance$HasJobs(project_id)
    expect_true(inherits(response, "logical"))

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("SaveJobConfig", {
  # tests for SaveJobConfig
  # base path: http://localhost:8080
  # Add new job configuration with given name.
  # Add new job configuration with given name.
  # @param name character name of the job-config to add
  # @param job_submission JobSubmission to add
  # @param override_existing character  (optional)

  config_name <- "SaveJobConfig"
  job_submission <- api_instance$GetDefaultJobConfig(TRUE)

  response <- api_instance$SaveJobConfig(config_name, job_submission, TRUE)
  expect_true(inherits(response, "StoredJobSubmission"))
  expect_equal(response$name, config_name)
})

test_that("StartJob", {
  # tests for StartJob
  # base path: http://localhost:8080
  # Start computation for given compounds and with given parameters.
  # Start computation for given compounds and with given parameters.
  # @param project_id character project-space to run jobs on
  # @param job_submission JobSubmission configuration of the job that will be submitted of the job to be returned
  # @param opt_fields array[JobOptField] set of optional fields to be included. Use 'none' only to override defaults. (optional)
  # @return [Job]

  tryCatch({

    project_id <- "StartJob"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    import_job <- projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file, ignore_formulas=TRUE)
    Sys.sleep(1)

    job_submission <- api_instance$GetDefaultJobConfig()
    job_submission$zodiacParams$enabled <- FALSE
    job_submission$fingerprintPredictionParams$enabled <- FALSE
    job_submission$canopusParams$enabled <- FALSE
    job_submission$structureDbSearchParams$enabled <- FALSE
    job_submission$msNovelistParams$enabled <- FALSE
    job_submission$alignedFeatureIds <- list(features_api$GetAlignedFeatures(project_id)[[1]]$alignedFeatureId)

    response <- api_instance$StartJob(project_id, job_submission)
    while (api_instance$GetJob(project_id, response$id)$progress$state == "RUNNING") {
      Sys.sleep(1)
    }

    expect_true(inherits(response, "Job"))

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})

test_that("StartJobFromConfig", {
  # tests for StartJobFromConfig
  # base path: http://localhost:8080
  # Start computation for given compounds and with parameters from a stored job-config.
  # Start computation for given compounds and with parameters from a stored job-config.
  # @param project_id character project-space to run jobs on
  # @param job_config_name character name if the config to be used
  # @param request_body array[character] List of alignedFeatureIds to be computed
  # @param recompute character enable or disable recompute. If null the stored value will be used. (optional)
  # @param opt_fields array[JobOptField] set of optional fields to be included. Use 'none' only to override defaults. (optional)
  # @return [Job]

  tryCatch({

    project_id <- "StartJobFromConfig"
    project_dir <- paste(Sys.getenv("HOME"), paste0(project_id, ".sirius"), sep="/")
    projects_api$CreateProject(project_id, project_dir)
    import_job <- projects_api$ImportPreprocessedDataAsJob(project_id, input_files=input_file, ignore_formulas=TRUE)
    Sys.sleep(1)

    job_submission <- api_instance$GetDefaultJobConfig()
    job_submission$zodiacParams$enabled <- FALSE
    job_submission$fingerprintPredictionParams$enabled <- FALSE
    job_submission$canopusParams$enabled <- FALSE
    job_submission$structureDbSearchParams$enabled <- FALSE
    job_submission$msNovelistParams$enabled <- FALSE
    job_submission$alignedFeatureIds <- list(features_api$GetAlignedFeatures(project_id)[[1]]$alignedFeatureId)

    api_instance$SaveJobConfig(project_id, job_submission, TRUE)
    response <- api_instance$StartJobFromConfig(project_id, project_id, job_submission$alignedFeatureIds)
    while (api_instance$GetJob(project_id, response$id)$progress$state == "RUNNING") {
      Sys.sleep(1)
    }

    expect_true(inherits(response, "Job"))

  }, finally = {

    projects_api$CloseProject(project_id)
    unlink(project_dir, recursive = TRUE)

  })
})
